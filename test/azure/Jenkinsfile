import static java.util.UUID.randomUUID

// TODO(colemickens): paramterize the subscription, tenant id, etc

// TODO(general): this could be broken out so that the config step could be parameterized...
//                so each provider can use whatever withEnv/Creds they want and populate '.config.json'

def subscriptioId = '27b750cd-ed43-42fd-9044-8d75e124ae55'
def tenantId = '72f988bf-86f1-41af-91ab-2d7cd011db47'
def azureMachinePassword = 'P@ssw0rdRes3t' // TODO: not ok

def dockerRepo = 'docker.io/colemickens'

node {
	checkout scm

	sh 'git rev-parse HEAD > commit'
	env.GIT_COMMIT = readFile('commit').trim()

	def kanyTag = "${dockerRepo}/k8s-ignition:${env.GIT_COMMIT}"
	def ignitionTag = "${dockerRepo}/k8s-ignition:${env.GIT_COMMIT}"

	stage 'build phase2'
	dir('phase2/ignition') {
		def ignitionImg = docker.build(ignitionTag, '--pull .')
		ignitionImg.push()
	}


	stage 'build kubernetes-anywhere'
	def kanyImg = docker.build(kanyTag, '--pull .')
	kanyImg.push()


	stage "deploy cluster"
	kanyImg.inside() {
		//sh('make deploy')
		// TODO: make 'make deploy wait, then install addons automatically
		echo 'make deploy'
	}
	archiveArtifacts artifacts: 'config.json', fingerprint: true
	archiveArtifacts artifacts: 'phase1/azure/.tmp/kubeconfig.json', fingerprint: true


	stage 'test cluster'
	input 'test cluster?'
	docker.inside() {
		withEnv(['KUBECONFIG=' + cwd() + '/phase1/azure/.tmp/kubeconfig.json']) {
			echo 'make conformtest'
			//make conformtest
		}
	}


	stage 'deploy cluster'
	input 'destroy cluster?'
	docker.inside() {
		//sh('make destroy')
		echo 'make destroy'
	}
}

def cwd = { ->
    sh 'pwd > pwd.current'
    return readFile('pwd.current').trim()
}

def getConfig(clusterName, ignitionTag, azureMachinePassword) {
	withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'azure_service_principal',
        usernameVariable: 'AZURE_CLIENT_ID', passwordVariable: 'AZURE_CLIENT_SECRET']]) {
		def configTest = """
			{
				"phase1": {
					"cluster_name": "${clusterName}",
					"azure": {
						"admin_password": "${azureMachinePassword}",
						"client_id": "${env.AZURE_CLIENT_ID}",
						"client_secret": "${env.AZURE_CLIENT_SECRET}"
					}
				},
				"phase2": {
					"installer_container": "${ignitionTag}"
				}
			}
		""".trim()

		writeFile(configTest, 'testconfig.json')

		def configTemplatePath = 'test/azure/config.json.template'
		def configTemplate = readFile('test/azure/config.json.template')
		return sh (
			//script: """echo "${configTemplate}" "${configTest}" | jq -r -s add""",
			script: "jq -s '.[0] * .[1]' testconfig.json ${configTemplatePath} > config.json"
			returnStdout: true
		).trim()
	}
}

// TODO(colemickens): paramterize the image name/push
