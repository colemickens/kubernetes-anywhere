import static java.util.UUID.randomUUID

// TODO(colemickens): paramterize the subscription, tenant id, etc

// TODO(general): this could be broken out so that the config step could be parameterized...
//                so each provider can use whatever withEnv/Creds they want and populate '.config.json'

node {
	deleteDir()
	checkout scm

	sh 'git rev-parse --short HEAD > commit'
	env.GIT_COMMIT = readFile('commit').trim()

	if (clusterName == "") {
		clusterName = "k8s-anywhere-${env.GIT_COMMIT}-${env.BUILD_NUMBER}"
	}
	if (azureMachinePassword == "") {
		azureMachinePassword = randomUUID()
	}
	def kanyTag = "${dockerRepo}/k8s-ignition:${env.GIT_COMMIT}-${env.BUILD_NUMBER}"
	def ignitionTag = "${dockerRepo}/k8s-ignition:${env.GIT_COMMIT}-${env.BUILD_NUMBER}"

	stage 'build phase2'
	dir('phase2/ignition') {
		def ignitionImg = docker.build(ignitionTag, '--pull .')
		ignitionImg.push()
	}


	stage 'build kubernetes-anywhere'
	def kanyImg = docker.build(kanyTag, '--pull .')
	kanyImg.push()


	kanyImg.inside() {
		withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'azure_service_principal',
			usernameVariable: 'AZURE_CLIENT_ID', passwordVariable: 'AZURE_CLIENT_SECRET']]) {

		stage "deploy cluster"
		def config = getConfig(clusterName, tenantId, subscriptionId, ignitionTag, randomUUID() as String)
		writeFile(file: '.config.json', text: config)
		writeFile(file: 'config.json', text: config)
		archiveArtifacts artifacts: 'config.json', fingerprint: true

		//*sh("cd ./phase1/azure && ./do deploy")*/
		sh("""set -x; \
		cat <<-EOF | make deploy
				
				${clusterName}
				azure \n \
				\n \
				\n \
				\n \
				\n \
				\n \
				\n \
				westus2\n \
				\n \
				${azureMachinePassword} \n \
				${tenantId} \n \
				${subscriptionId} \n \
				${env.AZURE_CLIENT_ID} \n \
				${env.AZURE_CLIENT_SECRET} \n \
				${ignitionTag} \n \
				gcr.io/google_containers \n \
				v1.3.5 \n \
				\n \
				\n \
				\n \
				\n \
				\n \
				\n \
		EOF""")

		sh("cat .config")

		sh("cp ./phase1/azure/.tmp/kubeconfig.json ./kubeconfig.json")
		archiveArtifacts artifacts: 'kubeconfig.json', fingerprint: true


		stage 'test cluster'
		//input 'test cluster?'
		//withEnv(['KUBECONFIG=' + cwd() + '/phase1/azure/.tmp/kubeconfig.json']) {
		//	echo 'make conformtest'
			//make conformtest
		//}


		stage 'destroy cluster'
		input 'destroy cluster?'
		withEnv(["FORCE_DESTROY=true"]) {
			sh("cd ./phase1/azure && ./do destroy")
		}
		}
	}
}

	def cwd() {
		sh 'pwd > pwd.current'
		return readFile('pwd.current').trim()
	}

	def getConfig(clusterName, tenantId, subscriptionId, ignitionTag, azureMachinePassword) {
				def configTest = """
					{
						"phase1": {
							"cluster_name": "${clusterName}",
							"azure": {
								"admin_password": "${azureMachinePassword}",
								"tenant_id": "${tenantId}",
								"subscription_id": "${subscriptionId}",
							"client_id": "${env.AZURE_CLIENT_ID}",
							"client_secret": "${env.AZURE_CLIENT_SECRET}"
						}
					},
					"phase2": {
						"installer_container": "${ignitionTag}"
					}
				}
			""".trim()

			writeFile(file: 'testconfig.json', text: configTest)

			def configTemplatePath = 'test/azure/config.json.template'
			def configTemplate = readFile('test/azure/config.json.template')
			return sh (
				script: "jq -s '.[0] * .[1]' ${configTemplatePath} testconfig.json",
				returnStdout: true
			).trim()
	}
